<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.maximusteam.tripfulaxel.trip.model.dao.TripMapper">
	
	<resultMap type="com.maximusteam.tripfulaxel.trip.model.dto.TripDTO" id="trip">
	
		<result property="tripCode" column="TRIP_CODE"/>
		<result property="tripTitle" column="TRIP_TITLE"/>
		<result property="tripIntro" column="TRIP_INTRO"/>
		<result property="tripStartDate" column="TRIP_START_DATE"/>
		<result property="meetLocation" column="TRIP_MEET_LOCATION"/>
		<result property="include" column="TRIP_INCLUDE"/>
		<result property="nInclude" column="TRIP_N_INCLUDE"/>
		<result property="tripEndDate" column="TRIP_END_DATE"/>
		
		<!-- join trip 부분 -->		
		<result property="joinTripMaximum" column="J_TRIP_MAXIMIM"/>
		<result property="joinTripCode" column="J_TRIP_CODE"/>
		
		<!-- guide trip 부분 -->
		<result property="guideTripCode" column="G_TRIP_CODE"/>
		<result property="payment" column="G_TRIP_PAYMENT"/>
		<result property="guideTripMinimum" column="G_TRIP_MINIMUM"/>
		<result property="guideTripMaximum" column="G_TRIP_MAXIMUM"/>
		
		<!-- user trip 부분 -->
		<result property="userTripCode" column="U_TRIP_CODE"/>
		<result property="userTripComentTitle" column="U_TRIP_COMENT_TITLE"/>
		<result property="userTripComent" column="U_TRIP_COMENT_INFO"/>
		<result property="userTripComentPoint" column="U_TRIP_COMENT_POINT"/>
		
		<!-- course -->
		<collection property="tripCourseList" ofType="com.maximusteam.tripfulaxel.trip.model.dto.TripCourseDTO">
			<result property="courseCode" column="TRIP_COURSE_CODE"/>
			<result property="courseName" column="TRIP_COURSE_NAME"/>
			<result property="courseInfo" column="TRIP_COURSE_INFO"/>
			<result property="image" column="TRIP_IMAGE_SAVED_NAME"/>
			<result property="tripCode" column="TRIP_CODE"/>
		</collection>
		
		<!-- image -->
		<collection property="tripImgList" ofType="com.maximusteam.tripfulaxel.trip.model.dto.TripImageDTO">
			<result property="tripCode" column="TRIP_CODE"/>
			<result property="saveName" column="TRIP_IMAGE_SAVED_NAME"/>
			<result property="orignName" column="TRIP_IMAGE_ORIGIN_NAME"/>
			<result property="imgType" column="TRIP_IMAGE_TYPE_CODE"/>
		</collection>
		
		<!-- theme -->
		<collection property="tripThemeList" ofType="com.maximusteam.tripfulaxel.trip.model.dto.TripThemeDTO">
			<result property="themeDetail" column="THEME_DETAIL"/>
			<result property="themeCode" column="THEME_CODE"/>
			<result property="tripCode" column="TRIP_CODE"/>
		</collection>
		
		<!-- transit -->
		<collection property="tripTransitList" ofType="com.maximusteam.tripfulaxel.trip.model.dto.TripTransitDTO">
			<result property="transitDetail" column="TRANSIT_DETAIL"/>
			<result property="transitCode" column="TRANSIT_CODE"/>
			<result property="tripCode" column="TRIP_CODE"/>
		</collection>
		
	</resultMap>
	
	<select id="selectTripList" resultMap="trip" parameterType="Map">
	
	SELECT	   
		   TRIP_TITLE,
		   TRIP_INTRO,
		   TRIP_START_DATE,
	   	   TRIP_MEET_LOCATION,
		   TRIP_INCLUDE,
		   TRIP_N_INCLUDE,
		   TRIP_END_DATE,
		   TRIP_TITLE,
		   TRIP_INTRO,
	       TRIP_START_DATE,
		   TRIP_MEET_LOCATION,
		   TRIP_INCLUDE,
		   TRIP_N_INCLUDE,
		   TRIP_END_DATE,
		   TRIP_IMAGE_SAVED_NAME,
		   TRIP_IMAGE_TYPE_CODE,
		   TRIP_IMAGE_ORIGIN_NAME,
		   TRIP_COURSE_CODE,
		   TRIP_COURSE_NAME,
		   TRIP_COURSE_INFO,
		   TRANSIT_CHOICE_CODE, 
	  	   t3.TRANSIT_CODE,
		   TRANSIT_DETAIL,
		   THEME_DETAIL,
		   THEME_CHOICE_CODE,
		   t2.THEME_CODE,
		   t.TRIP_CODE,
		<if test="condition.sortCondition eq '인기순'.toString()">
		 	IFNULL(iv.CNT, 0) as rvcnt,
		</if>
  
		<choose>
			 <!-- 같이가요 일때 -->
			 <when test='condition.tripType == 2'>
				   J_TRIP_CODE,
				   J_TRIP_MAXIMIM,
				   ti.TRIP_IMAGE_CODE
			  FROM JOIN_TRIP jt 
			  JOIN TRIP t ON (jt.TRIP_CODE = t.TRIP_CODE)
			 </when>
			 
			 <!-- guide 일 때 -->
			 <when test='condition.tripType == 1'>
				   G_TRIP_CODE,
				   G_TRIP_PAYMENT,
				   G_TRIP_MINIMUM,
				   G_TRIP_MAXIMUM,
				   ti.TRIP_IMAGE_CODE
			  FROM GUIDE_TRIP gt 
			  JOIN TRIP t ON (gt.TRIP_CODE = t.TRIP_CODE)
			 </when>
			 
			 <!-- 나만의 여행 일 때 -->  
			 <otherwise>
				   U_TRIP_CODE,
				   U_TRIP_COMENT_TITLE,
				   U_TRIP_COMENT_INFO,
				   U_TRIP_COMENT_POINT,
				   ti.TRIP_IMAGE_CODE
			  FROM USER_TRIP ut 
			  JOIN TRIP t ON (ut.TRIP_CODE = t.TRIP_CODE)
		  
			 </otherwise>
		</choose>
	  JOIN TRIP_IMAGE ti ON (t.TRIP_CODE = ti.TRIP_CODE)
	  JOIN TRIP_COURSE tc ON (ti.TRIP_IMAGE_CODE = tc.TRIP_IMAGE_CODE)
	  JOIN TRIP_THEME_CHOICE ttc ON (t.TRIP_CODE = ttc.TRIP_CODE)
	  JOIN THEME t2 ON (ttc.THEME_CODE = t2.THEME_CODE)
	  JOIN TRANSIT_CHOICE tc2 ON (t.TRIP_CODE = tc2.TRIP_CODE)
	  JOIN TRANSIT t3 ON (tc2.TRANSIT_CODE = t3.TRANSIT_CODE)
	  JOIN TRIP_REGIST_LIST trl ON (t.TRIP_CODE = trl.TRIP_CODE)
	  
	  <!-- 첫 정렬은 최신순이며 인기 순이 선택되었을때 리뷰 카운트를 세는 join이 추가됨 -->
	  <if test="condition.sortCondition eq '인기순'.toString()">
	  LEFT OUTER JOIN ( SELECT 
  				TRIP_CODE,
	   		    COUNT(tr.TRIP_REVIEW_CODE) as CNT
	   	   FROM TRIP_REGIST_LIST trl2
	   	   JOIN JOIN_TRIP_APPLY jta ON (trl2.TRIP_REGIST_LIST_CODE = jta.TRIP_REGIST_LIST_CODE)
	   	   JOIN TRIP_REVIEW tr ON (jta.JOIN_TRIP_APPLY_CODE = tr.JOIN_TRIP_APPLY_CODE)
	   	  WHERE trl2.TRIP_TYPE_CODE = #{condition.tripType}
		    AND trl2.REGIST_TYPE_CODE = 3
		  GROUP BY trl2.TRIP_CODE 
	   	   ) as iv ON (gt.TRIP_CODE = iv.TRIP_CODE)
	  </if>
	  
	  <choose>
		  <!--  페이지 첫 호출시 기본 정렬 상태 -> 최신순만 정렬함. 테마는 정렬 x-->
		  <when test="condition.sortTheme == 0">
			   WHERE trl.TRIP_TYPE_CODE = #{condition.tripType}
		      	 AND trl.REGIST_TYPE_CODE = 3
		      	 
		       <if test="condition.sortCondition eq '최신순'.toString()">
		      		  ORDER BY t.TRIP_CODE DESC
		       </if>
		       <!-- 정렬이 인기순으로 선택시 위에 조인하여 셀렉해온 리뷰 수 기준으로 정렬해옴 -->
		       <if test="condition.sortCondition eq '인기순'.toString()">
		      		  ORDER BY rvcnt DESC;
		       </if>
		  </when>
				  
				<!-- 첫 호출이 아닌 상태 최신순/인기순 and 테마가 선택되어 있음 -->
		  <otherwise>
			   WHERE trl.TRIP_TYPE_CODE = #{condition.tripType}
		      	 AND trl.REGIST_TYPE_CODE = 3
		      	 AND ttc.THEME_CODE = #{condition.sortTheme}
		      	 
		       <if test="condition.sortCondition eq '최신순'.toString()">
		      		  ORDER BY t.TRIP_CODE DESC
		       </if>
		       <!-- 정렬이 인기순으로 선택시 위에 조인하여 셀렉해온 리뷰 수 기준으로 정렬해옴 -->
		       <if test="condition.sortCondition eq '인기순'.toString()">
		      		  ORDER BY rvcnt DESC;
		       </if>
		    </otherwise>
	   </choose>
		
	</select>
	
</mapper>